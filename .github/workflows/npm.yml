name: cohort_sdk_js
on:
    #workflow_call:
    push:
env:
    DEBUG: "napi:*"
jobs:
    npm:
        strategy:
            fail-fast: false
            matrix:
                settings:
                  - host: macos-latest
                    target: x86_64-apple-darwin
                    jsPackageHome: packages/cohort_sdk_js
                    finalPackageName: packages/cohort_sdk_js/cohort_sdk_js.darwin-x64.node
                    customiseHostCommand: echo 'No customizations are needed'
                    buildCommand: npm run build -- --target x86_64-apple-darwin

                  - host: macos-latest
                    target: aarch64-apple-darwin
                    jsPackageHome: packages/cohort_sdk_js
                    finalPackageName: packages/cohort_sdk_js/cohort_sdk_js.darwin-arm64.node
                    customiseHostCommand: |-
                      brew install FiloSottile/musl-cross/musl-cross
                      brew install FiloSottile/musl-cross/musl-cross --with-aarch64
                      brew install openssl@1.1
                      brew --prefix
                      find $(brew --prefix) -name "libcrypto.*"
                    buildCommand: npm run build -- --target aarch64-apple-darwin

                  - host: windows-latest
                    target: x86_64-pc-windows-msvc
                    jsPackageHome: packages\\cohort_sdk_js
                    finalPackageName: packages\cohort_sdk_js\cohort_sdk_js.*.node
                    # customiseHostCommand: ECHO 'No customizations are needed'
                    customiseHostCommand: |-
                      SET
                      choco install openssl --version=1.1.1.2100
                      choco install make
                      ECHO "ProgramData = "
                      ECHO "%ProgramData%"
                      DIR "C:\\ProgramData\\chocolatey"
                      DIR "C:\ProgramData\chocolatey"
                      setx OPENSSL_LIB_DIR "C:\\ProgramData\\chocolatey\\lib"
                      SET
                    buildCommand: npm run build -- --target x86_64-pc-windows-msvc

                  - host: ubuntu-latest
                    target: x86_64-unknown-linux-gnu
                    jsPackageHome: packages/cohort_sdk_js
                    finalPackageName: packages/cohort_sdk_js/cohort_sdk_js.linux-x64-gnu.node
                    customiseHostCommand: sudo apt-get update -y && sudo apt-get install -y libsasl2-dev
                    buildCommand: npm run build -- --target x86_64-unknown-linux-gnu

        name: stable - ${{ matrix.settings.target }} - node@16
        runs-on: ${{ matrix.settings.host }}
        steps:
            - uses: actions/checkout@v3

            - name: Setup node
              uses: actions/setup-node@v3
              with:
                  node-version: 16
                  check-latest: true

            - name: Install
              uses: actions-rs/toolchain@v1
              with:
                  profile: minimal
                  override: true
                  toolchain: stable
                  target: ${{ matrix.settings.target }}

            - name: Customise host image
              shell: bash
              run: ${{ matrix.settings.customiseHostCommand }}

            - name: Show current directory name
              shell: bash
              run: pwd

            - name: List content before build
              shell: bash
              run: ls -l && ls -l ${{ matrix.settings.jsPackageHome }}

            # - name: Cache cargo TODO deal with caching
            - name: Install node dependencies
              run: cd ${{ matrix.settings.jsPackageHome }} && pwd && ls -l . && npm install -verbose

            - name: Cargo build
              run: cargo build

            - name: NAPI-RS build
              shell: bash
              run: cd ${{ matrix.settings.jsPackageHome }} && ${{ matrix.settings.buildCommand }}

            - name: List content after build
              shell: bash
              run: ls -l && ls -l ${{ matrix.settings.jsPackageHome }}

            - name: Upload built binary
              uses: actions/upload-artifact@v3
              with:
                  name: bindings-${{ matrix.settings.target }}
                  path: ${{ matrix.settings.finalPackageName }}
                  if-no-files-found: error